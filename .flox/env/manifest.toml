#
# This is a Flox environment manifest.
# Visit flox.dev/docs/concepts/manifest/
# or see flox-edit(1), manifest.toml(5) for more information.
#
# Flox manifest version managed by Flox CLI
version = 1

# List packages you wish to install in your environment inside
# the `[install]` section.
[install]
gh.pkg-path = "gh"
yamlfmt.pkg-path = "yamlfmt"
nodejs_22.pkg-path = "nodejs_22"
jq.pkg-path = "jq"


# Set environment variables in the `[vars]` section. These variables may not
# reference one another, and are added to the environment without first
# expanding them. They are available for use in the `[profile]` and `[hook]`
# scripts.
[vars]
# message = "Howdy"

# The `hook.on-activate` script is run by the *bash* shell immediately upon
# activating an environment, and will not be invoked if Flox detects that the
# environment has previously been activated. Variables set by the script will
# be inherited by `[profile]` scripts defined below. Note that any stdout
# generated by the script will be redirected to stderr.
[hook]
on-activate = """
echo Welcome to Canto

"""

# Scripts defined in the `[profile]` section are *sourced* by *your shell* and
# inherit environment variables set in the `[vars]` section and by `[hook]` scripts.
# The `profile.common` script is sourced by all shells and special care should be
# taken to ensure compatibility with all shells, after which exactly one of
# `profile.{bash,fish,tcsh,zsh}` is sourced by the corresponding shell.
[profile]
common = '''
  export GH_PAGER=cat
  alias bclean='git branch | egrep -v "(^\*|main)" | xargs git branch -D'
  
run() {
    echo "+ $*" >&2
    "$@"
}

ghpr() {
  # check GitHub CLI auth
  if ! gh auth status --active &>/dev/null; then
    echo "Error: You are not logged into GitHub CLI."
    echo "Run: gh auth login"
    return 1
  fi

  local message=""
  while getopts "m:" opt; do
    case $opt in
      m) message="$OPTARG" ;;
      *) echo "Usage: pr -m \"commit message\"" >&2; return 1 ;;
    esac
  done

  if [[ -z "$message" ]]; then
    echo "INFO: commit message is required (-m)" >&2
    echo "You can checkout the following PRs: (gh pr checkout PR_NUMBER)"
    run gh pr list | cat
    return 1
  fi

  # check for staged changes
  if git diff --cached --quiet; then
    echo "❌ Error: No staged changes. Stage your changes with 'git add' before running." >&2
    return 1
  fi

  # remember current branch in case we need to roll back
  local orig_branch
  orig_branch=$(git rev-parse --abbrev-ref HEAD)

  local branch="ghpr-$(date +%s)-$RANDOM"
  run git checkout -b "$branch"

  if ! run git commit -m "$message"; then
    echo "❌ Commit failed. Returning to original branch: $orig_branch" >&2
    git checkout "$orig_branch" >/dev/null 2>&1 || {
      echo "⚠️ Failed to return to $orig_branch" >&2
    }
    # Optionally, delete the new branch to keep things clean
    git branch -D "$branch" >/dev/null 2>&1 || true
    return 1
  fi

  run gh pr create --editor --template pull_request_template.md --reviewer @blended-labs/devs
  echo "On branch: $(git rev-parse --abbrev-ref HEAD)"
}
'''

# The `[services]` section of the manifest allows you to define services.
# Services defined here use the packages provided by the `[install]` section
# and any variables you've defined in the `[vars]` section or `hook.on-activate` script.
[services]
# postgres.command = "postgres --config-file=pg.conf"

# Additional options can be set in the `[options]` section. Refer to
# manifest.toml(5) for a list of available options.
[options]
systems = ["aarch64-darwin", "aarch64-linux", "x86_64-darwin", "x86_64-linux"]
# Uncomment to disable CUDA detection.
# cuda-detection = false
